# Как работает Дока

## Репозитории

Дока живёт на гитхабе и работает на базе нескольких репозиториев:

- [Контент](https://github.com/doka-guide/content), в котором находятся все материалы;
- [Платформа](https://github.com/doka-guide/platform), в котором находится весь код сборки и клиентский код веб-приложения;
- [Бекенд](https://github.com/doka-guide/api), в котором находится API Доки;
- [Поиск](https://github.com/doka-guide/search), в котором хранится API для организации поиска по контенту.

Авторы Доки в основном взаимодействуют с репозиторием **Контент**, в котором хранятся доки, статьи и практики для всех разделов, а также материалы из рубрики «На собеседовании».

**Платформа** основана на генераторе статических сайтов [11ty](https://www.11ty.dev). Страницы сайта свёрстаны в виде шаблонов в формате [Nunjucks](https://mozilla.github.io/nunjucks/).

**Бекенд** является классическим REST API, реализованным на языке Go. API позволяет сохранять заполненные пользователями сайта формы и реакции на статьи, а также является платформой для организации рассылок по электронной почте.

**Поиск** содержит движок, который позволяет искать по заранее подготовленному инвертированному индексу. Индекс готовится заранее и формируется во время развёртывания сайта из основной ветки.

Репозитории Контент и Платформа используются для сборки статического сайта, Бекенд и Поиск — для интерактивности сайта.

Все репозитории являются открытыми, мы всегда ждём новых контрибьюторов. Работа в репозиториях организована по схеме GitHub Flow: существует основная ветка `main`, в которой хранится текущая версия продукта, и другие ветки с изменениями, которые проходят ревью в пул реквестах.

## Платформа

Для сборки сайта необходимо подключать Контент, который является независимым репозиторием и ничего «не знает» о Платформе. Платформа «знает» кое-что о Контенте: пути, список и цвета разделов, настройки материалов и структуру папок материалов.

### Константы и поведение по умолчанию

**Список переменных окружения**:

- `BASE_URL` - базовый адрес для сайта;
- `SECTIONS` - список разделов сайта;
- `PATH_TO_CONTENT` - путь до репозитория с контентом;
- `CONTENT_REP_FOLDERS` - папки с содержимым разделов и служебной информацией для сборки;
- `DOKA_ORG` - путь до организации на GitHub;
- `PLATFORM_REP_GITHUB_URL` - путь до репозитория с платформой на GitHub;
- `CONTENT_REP_GITHUB_URL` - путь до репозитория с контентом на GitHub;
- `CONTENT_REP_GITHUB` - ссылка до репозитория с контентом на GitHub для работы с Git;
- `SERVER_PATH` - абсолютный путь до папки на сервере с текущей сборкой;
- `GITHUB_TOKEN` - токен для работы с GraphQL GitHub (персональный токен можно сгенерировать, как описано в [инструкции](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)).

Если оставить поле `GITHUB_TOKEN` пустым, на страницах участников не будет отображена информация об активности на GitHub в репозитории с контентом.

Список разделов Доки, которые попадают в сборку сайта, задаётся переменной `SECTIONS` в файлах _[.env.example](https://github.com/doka-guide/platform/blob/main/.env.example)_, в котором задаются переменные окружения, и _[constants.js](https://github.com/doka-guide/platform/blob/main/config/constants.js)_, в котором указываются значения по умолчанию, если они не заданы в файле с переменными окружения.

Цвета разделов определяются в файлах _[category-colors.js](https://github.com/doka-guide/platform/blob/main/config/category-colors.js)_, _[base-colors.css](https://github.com/doka-guide/platform/blob/main/src/styles/base-colors.css)_ (базовые цвета), _[light-theme.css](https://github.com/doka-guide/platform/blob/main/src/styles/light-theme.css)_ (для светлой темы) и _[dark-theme.css](https://github.com/doka-guide/platform/blob/main/src/styles/dark-theme.css)_ (для тёмной темы).

**Пути**

Поскольку сайт формируется из двух репозиториев для Платформы необходимо подготовить набор путей с материалами Контента перед сборкой. Для этого выполняется скрипт _[make-links.js](https://github.com/doka-guide/platform/blob/main/make-links.js)_ в одном из двух режимах: локально для пользователей — в интерактивном, на сервере — в режиме развёртывания. По умолчанию папки из Контента встраиваются с помощью ссылок в папку _src_.

Структура папок Платформы следующая:

```bash
platform
  ├── .github         # Служебная папка для GitHub
  ├── config          # Папка с файлами конфигурации
  ├── docs            # Документация Платформы Доки
  └── src             # Исходный код для сборки
      ├── data        # Папка с подключением данных (сущность 11ty)
      ├── fonts       # Папка с подготовленными шрифтами
      ├── images      # Папка с иконками и неконтентными картинками сайта
      ├── includes    # Папка с шаблонами некоторых блоков
      ├── layouts     # Папка с основой разметки страниц
      ├── libs        # Папка с библиотеками для сборки
      ├── scripts     # Папка со скриптами для сборки и клиента
      ├── styles      # Стили сайта
      ├── transforms  # Трансформации (сущность 11ty)
      └── views       # Представления основных страниц сайта
```

**Сборка сайта**

_.eleventy.js_ — основной файл для сборки, в котором прописывается конфигурация движка 11ty.

Сущности 11ty:

- контент — тексты на сайте (в Доке файлы с контентом хранятся в подпапках папки _src_ с расширениями _*.md_ и _*.html_) и различные медиафайлы;
- шаблоны — основной способ для формирования разметки (в Доке это файлы с разметкой страниц или блоков страниц с расширениями _*.njk_);
- данные — заранее записанные или специально подготовленные с помощью JS данные, необходимые для сборки (в Доке это файлы с расширениями _*.11tydata.js_);
- коллекции — специальный объект движка, в котором могут хранится специально подготовленные данные (в Доке коллекции задаются в основном файле конфигурации);
- трансформации — процесс обработки уже готовых страниц сайта;
- пермалинки — используются для обеспечения гибкости движка по отношению к пути хранения файла с контентом при формировании пути до страницы на сайте.

Сборка сайта осуществляется в следующем порядке:

1. Поиск файлов с вёрсткой и контентом в репозитории по указанным путям (в Доке это файлы формата _*.njk_ и _*.md_ соответственно).
2. Проход по всем найденным файлам:
   - Формирование списка всех файлов, которые не являются файлами с контентом (в Доке это шрифты, стили, клиентские скрипты, иконки, фото, видео и пр.).
   - Предварительная обработка шаблонов и подготовка контента для шаблонов.
3. Асинхронное копирование всех файлов, которые не являются файлами с контентом. Копирование проходит параллельно предварительным стадиям.
4. Формирование данных (содержаться в файлах _*.11tydata.js_) и вычисляемых значений для сборки (необходимо, чтобы заполнить готовые шаблоны контентом).
5. Формирование графа зависимостей в следующем порядке:
  - обработка шаблонов, которые не содержат зависимостей;
  - обработка шаблонов, которые используют теги (встроенное поле в мете файлов с контентом);
  - обработка шаблонов, которые используют пагинацию и любые другие коллекции;
  - обработка шаблонов, которые используют пагинацию и Configuration API, которое добавляет коллекции;
  - обработка шаблонов, которые используют пагинацию и готовят локальные объекты с коллекциями `collection`;
  - обработка шаблонов, которые используют пагинацию и готовят глобальный объект с коллекциями `collection.all`;
6. Формирование коллекций в правильном порядке для графа зависимостей.
6. Формирование дополнительного графа зависимостей для формирования вычисляемых данных, пермалинков, путей исходных файлов с контентом.
6. Обработка шаблонов без формирования разметки страниц.
6. Проверка на дубликаты.
6. Обработка шаблонов с формированием окончательной разметки страниц.
6. Применение трансформаций.

В файле конфигурации настраиваются папки, в которых хранятся разные типы сущностей. В Доке папки используются следующим образом:

- _dist_ — для хранения собранного сайта;
- _src_ — для хранения исходного кода сайта;
- _src/data_ — для хранения глобальных данных сайта;
- _src/includes_ — для хранения разметки блоков страниц;
- _src/layouts_ — для хранения основной разметки страниц.

В качестве основной библиотеки для обработки файлов с контентом используется библиотека `markdown-it`. Однако, по умолчанию библиотека обрабатывает видео не так, как это нужно в Доке. Поэтому используется [собственное решение](https://github.com/doka-guide/platform/blob/main/src/markdown-it.js).

Особое внимание при сборке сайта Доки уделяется трансформациям, то есть постобработке готовой разметки страниц. Используются следующие трансформации:

1. `answers-link-transform` — правит пути к демкам и картинкам, которые вставлены в раздел «На практике».
1. `article-code-blocks-transform` — формирует разметку для блоков с кодом в тексте материалов с возможностью копирования.
1. `article-inline-code-transform` — формирует разметку для кода в тексте материалов с возможностью копирования.
1. `callout-transform` — формирует разметку для коллаутов.
1. `code-breakify-transform` — расставляет переносы в тексте для кода.
1. `code-classes-transform` — расставляет классы на инлайновые блоки с кодом.
1. `color-picker-transform` — добавляет квадратики с цветом в коде после упоминания.
1. `demo-external-link-transform` — добавляет ссылки для открытия демок в новом окне.
1. `demo-link-transform` — правит пути к демкам и картинкам, которые вставлены в раздел «На практике».
1. `details-transform` — оборачивает содержимое details в блоки с классом `.content`.
1. `headings-anchor-transform` — генерирует якорные ссылки на заголовки.
1. `headings-id-transform` — генерирует разметку для формирования аттрибутов `id` заголовков.
1. `iframe-attr-transform` — добавляет атрибуты к iframe, если их нет.
1. `image-place-transform` — помещает изображения с подписями внутрь figure.
1. `image-transform` — готовит картинки в разных форматах для оптимизации загрузки страниц.
1. `link-transform` — добавляет классы к ссылкам.
1. `table-transform` — оборачивает таблицы в контейнеры с прокруткой.
1. `toc-transform` — генерирует оглавление страницы.

**Тесты**

В Доке применяются модульное тестирование с помощью фреймворка [Jest](https://jestjs.io), конфигурация которого находится в файлах _[jest.config.js](https://github.com/doka-guide/platform/blob/main/jest.config.js)_ и _[jest.setup.js](https://github.com/doka-guide/platform/blob/main/jest.setup.js)_. Сами тесты находятся в подпапке _ __tests__ _ папок со скриптами.

**Скрипты запуска**

Для работы платформы можно использовать разные режимы (описаны в файле _[package.json](https://github.com/doka-guide/platform/blob/main/package.json)_):

- `debug` — для отладки платформы и контента (сайт не падает, если что-то пошло не так, а информирует о том, что случилось);
- `start` — для запуска платформы локально с автоперезагрузкой при изменении файлов контента или платформы;
- `build` — для сборки сайта (с минификацей кода и всеми трансформациями);
- `preview` — для предварительного просмотра сборки (без минификации кода и всеми трансформациями кроме `image-transform`);
- `deploy` — для развёртывания сайта на инфраструктуре Доки (при наличии доступа);
- `editorconfig` — для проверки файлов на требования Editorconfig, согласно [конфигурации](https://github.com/doka-guide/platform/blob/main/.editorconfig);
- `stylelint` — для проверки файлов на требования Stylelint, согласно [конфигурации](https://github.com/doka-guide/platform/blob/main/.stylelintrc.json);
- `eslint` — для проверки файлов на требования ESLint, согласно [конфигурации](https://github.com/doka-guide/platform/blob/main/.eslintrc.json);
- `lint-check` — запуск всех линтеров;
- `test` — запуск модульных тестов;
- `make-links` — для формирования символьных ссылок на контент.

**Шаблоны**

Шаблоны в Доке реализованы с помощью [Nunjucks](https://mozilla.github.io/nunjucks/). В папке _src/layouts_ содержится один базовый шаблон _base.njk_ с основной разметкой любой страницы на сайте. В нём формируется основные теги `<html>`, `<head>` и `<body>`, подключается микроразметка и метатеги с помощью _meta.njk_, к странице подключаются стили и скрипты клиентского кода.

Шаблоны страниц сайта находятся в папке _src/views_:

- _404.njk_ — страница, которая показывается, если по указанному адресу страницы нет;
- _all.njk_ — страница с индексом по всем материалам (докам, статьям);
- _article-index.njk_ — страницы с индексом материалов по каждому разделу;
- _doc.njk_ — страницы с материалами (доки, статьи);
- _feed.njk_ — XML-документ для организации фида для RSS;
- _index.njk_ — главная страница сайта;
- _page.njk_ — страницы с текстами, которые не являются материалами (доками, статьями);
- _people.njk_ — страница со списком участников (контрибьюторов);
- _person-json.njk_ — информация об участнике (контрибьюторе) проекта в формате JSON*
- _person.njk_ — персональные страницы участников (контрибьюторов);
- _sc-index.njk_ — карточки для социальных сетей (необходимо для формирования картинки для социальных сетей) в формате HTML для разделов;
- _sc.njk_ — карточки для социальных сетей (необходимо для формирования картинки для социальных сетей) в формате HTML для материалов (док, статей);
- _search.njk_ — страница поиска;
- _sitemap.njk_ — XML-документ — карта сайта;
- _specials.njk_ — страницы специальных проектов;
- _subscribe.njk_ — страница для управления подпиской на рассылку по электронной почте.

Шаблоны отдельных блоков страниц находятся в папке _src/includes_:

- _analytics/google.njk_ — подключение Google Analytics на сайт;
- _analytics/metrika.njk_ — подключения Яндекс.Метрики на сайт;
- _blocks/article-image.njk_ — иллюстрации материалов (док, статей);
- ~~_blocks/aside.njk_ — вёрстка страниц с боковой навигацией (пока не используется)~~;
- _blocks/cookie-notification.njk_ — попап с информацией об использовании кук;
- _blocks/featured-article.njk_ — блок показа одного материала для фичеринга на главной странице сайта;
- _blocks/footer.njk_ — футер сайта (переключатель темы, вторичное меню);
- _blocks/header.njk_ — шапка сайта (лого, хлебные крошки, поиск, основное меню);
- _blocks/linked-article.njk_ — кнопки для перехода на предыдущий или следующий материал раздела;
- _blocks/logo.njk_ — вёрстка для логотипа;
- _blocks/nav-list.njk_ — меню со списком разделов сайта;
- _blocks/person-avatar.njk_ — аватар участника (контрибьютора);
- _blocks/person-badges.njk_ — набор значков участника (контрибьютора);
- _blocks/person.njk_ — представление краткой информации об участнике (контрибьюторе) на странице со спиком участников (контрибьюторов);
- _blocks/search-category.njk_ — фильтр по категориям для страницы поиска;
- _blocks/search-hits.njk_ — один результат поиска с краткой информацией о материале;
- _blocks/search-tags.njk_ — фильтр по типу материала для страницы поиска;
- _blocks/search.njk_ — блок поиска в основном меню;
- _blocks/snow-toggle.njk_ — переключатель для падающего снега (запускается в новогодние праздники);
- _blocks/snow.njk_ — блок, реализующий падающий снег (запускается в новогодние праздники);
- _blocks/social-card.njk_ — карточка для социальных сетей (необходимо для формирования картинки для социальных сетей);
- _blocks/theme-toggle.njk_ — переключатель темы на сайте;
- _articles-gallery.njk_ — блок со всеми материалами на главной странице, которые были выбраны для фичеринга (список материалов обновляется каждую неделю);
- _contributors.njk_ — блок для материалов, в котором показаны все причастные участники (авторы, редакторы, контрибьюторы)
- _feedback-form.njk_ — форма для отправки обратной связи для материалов (док, статей);
- _meta.njk_ — подключение иконок, манифеста, шрифтов и стилей, настройки доступных тем, формирование метатегов и микроразметки страниц;
- _practices.njk_ — блок рубрики «На практике» в материалах (доках, статьях);
- _questions.njk_ — блок рубрики «На собеседовании» в материалах (доках, статьях);
- _related-articles-gallery.njk_ — блок для представления связанных док и статей с текущим материалом;
- _subscribe-popup.njk_ — попап для отправки электронной почты, чтобы подписаться на регулярную рассылку.
